<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vajrayāna: An Interactive Journey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Library for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        .mountain-bg {
            background-image: linear-gradient(to top, #a1a1aa, #d4d4d8, #e5e7eb, #f9fafb, #ffffff);
        }
        .node {
            transition: all 0.3s ease-in-out;
            cursor: pointer;
        }
        .node:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 10px 8px rgb(0 0 0 / 0.1)) drop-shadow(0 4px 3px rgb(0 0 0 / 0.1));
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        .path-line {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw-path 5s ease-in-out forwards;
        }
        @keyframes draw-path {
            to {
                stroke-dashoffset: 0;
            }
        }
        .pulsate {
            animation: pulsate 2s infinite;
        }
        @keyframes pulsate {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .gemini-btn, #download-pdf-btn {
            transition: all 0.2s ease-in-out;
        }
        .gemini-btn:hover, #download-pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .accordion-btn {
            width: 100%;
            background-color: #f1f5f9;
            color: #1e293b;
            cursor: pointer;
            padding: 1rem;
            text-align: left;
            border: none;
            border-top: 1px solid #e2e8f0;
            transition: background-color 0.3s;
            font-weight: 600;
            font-size: 1.125rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion-btn:hover {
            background-color: #e2e8f0;
        }
        .accordion-content {
            padding: 0 1rem;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-icon {
            transition: transform 0.3s;
        }
        .accordion-btn.active .accordion-icon {
            transform: rotate(180deg);
        }

        /* Ensure video iframe is responsive */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            border-radius: 1rem;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-40 shadow-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-center items-center relative">
                <div class="text-center">
                    <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Vajrayāna: The Culmination of the Path</h1>
                    <p class="mt-2 text-lg text-slate-600">An Interactive Journey with ✨ Gemini AI</p>
                </div>
                <button id="download-pdf-btn" class="absolute right-4 top-1/2 -translate-y-1/2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors hidden md:block">Download as PDF</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Video Introduction Section -->
        <div id="video-section" class="mb-8 bg-white rounded-2xl shadow-lg p-6 md:p-10">
            <h2 class="text-2xl font-bold text-slate-700 text-center mb-4">An Introduction to the Path</h2>
            <div class="video-container max-w-4xl mx-auto">
                <!--
                  INSTRUCTION: To add your video, get the 'embed' code from YouTube or Vimeo.
                  It will look like an <iframe> tag.
                  Replace the entire <iframe> tag below with the one you copied.
                -->
                <iframe
                    src="https://www.youtube.com/embed/yYDyA6Zdyts"
                    title="YouTube video player"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                </iframe>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-10 mountain-bg overflow-hidden">
            <div class="text-center mb-12">
                <h2 class="text-2xl font-bold text-slate-700">The Path to Enlightenment</h2>
                <p class="mt-2 text-slate-500 max-w-3xl mx-auto">This infographic visualizes the Vajrayāna path as an ascent. Click on each point to reveal key concepts and use the ✨ Gemini-powered features to deepen your understanding.</p>
            </div>

            <!-- The Mountain Path SVG -->
            <div class="relative w-full max-w-5xl mx-auto" style="height: 1200px;">
                <svg width="100%" height="100%" viewBox="0 0 800 1200" preserveAspectRatio="xMidYMid meet">
                    <!-- Path Line -->
                    <path d="M 400 1150 C 450 1000, 350 900, 400 800 C 450 700, 350 600, 400 500 C 450 400, 350 300, 400 200 C 450 150, 400 100, 400 50" stroke="#71717a" stroke-width="4" fill="none" class="path-line" stroke-linecap="round"/>

                    <!-- Nodes on the path -->
                    <g class="node" onclick="showModal('foundation')"><circle cx="400" cy="1150" r="25" fill="#475569" /><text x="400" y="1155" font-size="20" fill="white" text-anchor="middle" class="font-bold">1</text><text x="400" y="1190" font-size="16" fill="#475569" text-anchor="middle" class="label font-semibold">The Foundation</text></g>
                    <g class="node" onclick="showModal('entering')"><circle cx="400" cy="800" r="25" fill="#64748b" /><text x="400" y="805" font-size="20" fill="white" text-anchor="middle" class="font-bold">2</text><text x="400" y="840" font-size="16" fill="#64748b" text-anchor="middle" class="label font-semibold">Entering the Path</text></g>
                    <g class="node" onclick="showModal('ascent')"><circle cx="400" cy="500" r="25" fill="#3b82f6" /><text x="400" y="505" font-size="20" fill="white" text-anchor="middle" class="font-bold">3</text><text x="400" y="540" font-size="16" fill="#3b82f6" text-anchor="middle" class="label font-semibold">The Ascent</text></g>
                    <g class="node" onclick="showModal('summit')"><circle cx="400" cy="200" r="25" fill="#8b5cf6" /><text x="400" y="205" font-size="20" fill="white" text-anchor="middle" class="font-bold">4</text><text x="400" y="240" font-size="16" fill="#8b5cf6" text-anchor="middle" class="label font-semibold">The Summit</text></g>
                    <g class="node pulsate" onclick="showModal('culmination')"><circle cx="400" cy="50" r="30" fill="#f59e0b" /><path d="M390,50 L400,35 L410,50 L400,65 Z" fill="white"/><text x="400" y="100" font-size="16" fill="#f59e0b" text-anchor="middle" class="label font-bold">The Culmination</text></g>
                </svg>
            </div>
        </div>
    </main>

    <!-- Modal Structure -->
    <div id="modal-container" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 hidden opacity-0" onclick="hideModal()">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6 md:p-8 transform scale-95" onclick="event.stopPropagation()">
            <!-- Content will be injected here by JS -->
        </div>
    </div>

<script>
    // --- DATA FOR MODALS ---
    const modalData = {
        foundation: {
            title: "1. The Foundation: Method & Wisdom",
            rawContent: `The foundation of Vajrayāna rests on the two pillars of Mahāyāna: Method and Wisdom. Method is Bodhicitta, the compassionate wish to attain enlightenment for all beings. Wisdom is the understanding of Emptiness (Śūnyatā), the lack of inherent existence in all phenomena. Vajrayāna is considered a swift path because it has unique techniques to unify these two aspects in a single moment of consciousness, whereas in the general Mahāyāna path, they are often cultivated alternately.`,
            tabs: [
                { title: "The Two Wings", content: `<p>A practitioner needs two "wings" to fly to enlightenment: Method and Wisdom. They are interdependent. Compassion without wisdom can be misdirected, and wisdom without compassion can lead to a self-centered peace that doesn't benefit others. The entire path is about developing these two in a balanced and unified way.</p>` },
                { title: "Method: Bodhicitta", content: `<p>Bodhicitta is the altruistic intention to achieve enlightenment for the sake of all sentient beings. It is the driving force of the Mahāyāna path. In Vajrayāna, this motivation is even more intense—an unbearable compassion that seeks the most rapid means to relieve others' suffering, making the practitioner a suitable vessel for these powerful techniques.</p>` },
                { title: "Wisdom: Emptiness", content: `<p>This is the correct view of reality, understanding that all things are "empty" of existing from their own side, independently. They arise in dependence on causes, conditions, and mental imputation. This wisdom is the ultimate antidote to ignorance, the root of all suffering.</p>` },
                { title: "Why Vajrayāna is Fast", content: `<p>The key distinction of Vajrayāna is its skillful means to bring Method and Wisdom into a single, non-dual consciousness. While the Sūtra path cultivates them sequentially, Tantra uses techniques like deity yoga to experience the appearance of the deity (Method) and its empty nature (Wisdom) simultaneously.</p>` }
            ]
        },
        entering: {
            title: "2. Entering the Path: Guru & Empowerment",
            rawContent: `Entry into Vajrayāna is a formal process, not a casual one. It requires a qualified Guru (spiritual mentor) who holds an authentic lineage. The entry point is the Empowerment (Abhiṣeka), a ritual that authorizes the student to practice a specific tantra. This transmission plants the seeds for realization but also entails taking on Commitments (Samaya), which are sacred vows that guide and protect the practice.`,
            tabs: [
                { title: "The Guru (Lama)", content: `<p>In Vajrayāna, the spiritual mentor is crucial. They are not just a teacher but a living link to the lineage of the practice, tracing back to the Buddha. The student must examine the guru's qualifications carefully, as this relationship is the foundation for the entire path. The guru transmits the empowerment, gives instructions, and guides the student's practice.</p>` },
                { title: "Empowerment (Abhiṣeka)", content: `<p>Literally meaning "anointing" or "sprinkling," empowerment is the ritual that formally introduces the student to the mandala of a specific deity. It's a complex process that works on multiple levels to ripen the student's mindstream, purify obstacles, and grant permission to engage in the generation and completion stage practices.</p>` },
                { title: "Samaya (Commitments)", content: `<p>These are the sacred vows and commitments taken during an empowerment. They are the "life-force" of the practice. They include root vows (e.g., maintaining bodhicitta, respecting the guru) and branch vows related to specific conduct. Upholding samaya is essential for the practice to be safe and effective.</p>` }
            ]
        },
        ascent: {
            title: "3. The Ascent: The Four Classes of Tantra",
            rawContent: `The Vajrayāna path is a gradual ascent through four classes of tantra. Kriyā (Action) and Caryā (Performance) Tantras involve both external rituals and internal meditation. Yoga (Union) Tantra focuses more on internal yoga. Anuttarayoga (Highest Yoga) Tantra is the pinnacle, using the most profound methods to work directly with the subtle body and mind to achieve enlightenment in one lifetime.`,
            tabs: [
                { title: "Kriyā & Caryā Tantra", content: `<p>These are the "lower" tantras. <strong>Kriyā (Action) Tantra</strong> emphasizes external activities like cleanliness, ritual offerings, and mantra recitation, with the practitioner viewing the deity as a powerful lord. <strong>Caryā (Performance) Tantra</strong> creates a balance between external actions and internal meditation, relating to the deity more as a friend.</p>` },
                { title: "Yoga Tantra", content: `<p>This class shifts the focus primarily to internal meditation (yoga). The goal is to unite one's own mind with the mind of the deity through deep concentration and visualization, seeing all phenomena as the pure display of the deity's wisdom.</p>` },
                { title: "Highest Yoga Tantra", content: `<p>This is the most profound and central class discussed in the book. It is unique because it works directly with the subtle energetic system of the body (channels, winds, and drops) to manifest the most fundamental level of consciousness and use it to realize emptiness. It is considered the swiftest path to Buddhahood.</p>` }
            ]
        },
        summit: {
            title: "4. The Summit: Highest Yoga Tantra",
            rawContent: `Highest Yoga Tantra features a two-stage practice. The Generation Stage involves purifying our perception by visualizing ourselves as a fully enlightened deity within a pure mandala. The Completion Stage uses advanced yogic techniques to manipulate the subtle energies (winds) in our body's channels, leading to the direct experience of the mind's most subtle level, the Clear Light, which is then used to realize emptiness.`,
            tabs: [
                { title: "The Subtle Body", content: `<p>This is a key concept in Highest Yoga Tantra. It's an energetic system that is the interface between mind and body, composed of: <ul><li class='ml-4'>• <strong>Channels (Nāḍī):</strong> Pathways for subtle energy.</li><li class='ml-4'>• <strong>Winds (Prāṇa):</strong> The energy currents that flow through the channels. They are the "mount" upon which consciousness rides.</li><li class='ml-4'>• <strong>Drops (Bindu):</strong> Concentrated points of essential energy located at key centers (chakras).</li></ul> By controlling the winds, a practitioner can control their mind at its most subtle levels.</p>` },
                { title: "Generation Stage", content: `<p>This is a practice of profound imagination. The practitioner meditates on emptiness and then arises from that state in the visualized form of an enlightened deity. This practice powerfully counteracts "ordinary appearance" (seeing things as mundane and solid) and "ordinary grasping" (clinging to a limited, impure self-identity). It is the cause for achieving a Buddha's Form Body.</p>` },
                { title: "Completion Stage", content: `<p>This is the pinnacle of yogic practice. Using techniques like breath control and internal heat (tummo), the practitioner draws the winds into the central channel. This systematically dissolves coarser levels of consciousness, leading to the manifestation of the <strong>Fundamental Innate Mind of Clear Light</strong>. This is the ultimate level of mind, which is then used to realize emptiness directly.</p>` }
            ]
        },
        culmination: {
            title: "The Culmination: Union of Bliss & Emptiness",
            rawContent: `The final goal is the non-dual realization of the Clear Light mind (experienced as great bliss) and Emptiness. This is Mahāmudrā, the Great Seal. This state is actualized through stages like the Illusory Body (a body of pure energy) and the Actual Clear Light. Their final unification is Buddhahood, the perfect state of a Buddha's mind (Truth Body) and form (Form Body).`,
            tabs: [
                { title: "The Great Seal (Mahāmudrā)", content: `<p>This refers to the ultimate realization of the path. It is the direct, non-dual experience where the subject (the blissful clear light mind) and the object (emptiness) are realized as an inseparable unity. It is the "seal" of reality itself, where all phenomena are seen as the union of appearance and emptiness.</p>` },
                { title: "Key Realizations", content: `<p>The path culminates in profound states: <ul><li class='ml-4'>• <strong>Illusory Body:</strong> The practitioner actually generates a subtle body made of the most subtle winds, which is the direct cause of a Buddha's Form Body.</li><li class='ml-4'>• <strong>Actual Clear Light:</strong> The direct, non-conceptual realization of emptiness by the most subtle mind, the cause of a Buddha's Truth Body (omniscient mind).</li><li class='ml-4'>• <strong>The State of Union:</strong> The final attainment where the purified Illusory Body and the Actual Clear Light become inseparable. This is full enlightenment.</li></ul></p>` },
                { title: "The Result", content: `<p>The result is Buddhahood—the complete eradication of all obscurations and the perfection of all positive qualities, such as wisdom and compassion. A Buddha possesses a Truth Body (the omniscient mind eternally absorbed in emptiness) and Form Bodies (which manifest effortlessly and spontaneously to benefit all beings). The entire Vajrayāna path is a skillful and swift method to actualize this result.</p>` }
            ]
        }
    };

    const modalContainer = document.getElementById('modal-container');
    const modalContent = document.getElementById('modal-content');

    // --- GEMINI API LOGIC ---
    async function callGemini(prompt, targetElement) {
        targetElement.innerHTML = '<div class="loader"></div>';
        targetElement.classList.remove('hidden');
        let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = { contents: chatHistory };
        // WARNING: This is a major security risk.
        // API keys should never be exposed in client-side code.
        // This is included for demonstration purposes only.
        // For a production application, this API call should be made from a secure backend server.
        const apiKey = "AIzaSyBv0x-3EdkidLIIhiZiZDCYCMIqPhGilXs";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        let response;
        let retries = 0;
        const maxRetries = 5;
        while (retries < maxRetries) {
            try {
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        const formattedText = text.split('\n').map(p => `<p class="mb-2">${p}</p>`).join('');
                        targetElement.innerHTML = formattedText;
                        return;
                    }
                }
            } catch (error) {
                console.error("Fetch error:", error);
            }
            retries++;
            if (retries < maxRetries) {
                const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            } else {
                targetElement.innerHTML = `<p class="text-red-500">Sorry, I couldn't get a response. Please try again later.</p>`;
            }
        }
    }

    // --- MODAL DISPLAY LOGIC ---
    function showModal(id) {
        const data = modalData[id];
        if (!data) return;

        let mainContentHtml = '';
        data.tabs.forEach(tab => {
            mainContentHtml += `
                <div class="prose max-w-none mb-4">
                    <h4 class="font-semibold text-lg text-slate-800">${tab.title}</h4>
                    ${tab.content}
                </div>
            `;
        });

        const aiToolsHtml = `
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-center text-slate-700 mb-4">Deepen Your Understanding</h3>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="explain-btn" class="gemini-btn bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md">✨ Explain Further</button>
                    <button id="meditate-btn" class="gemini-btn bg-purple-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md">✨ Generate Guided Meditation</button>
                </div>
                <div id="gemini-output" class="mt-6 bg-slate-50 p-4 rounded-lg border hidden"></div>
            </div>
        `;

        const qaHtml = `
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-center text-slate-700 mb-4">Interactive Q&A</h3>
                <p class="text-slate-600 mb-3 text-center">Ask a question about this topic, and the AI will provide an answer.</p>
                <div class="flex gap-2">
                    <input type="text" id="qa-input" class="flex-grow border border-slate-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., What is the purpose of a guru?">
                    <button id="qa-btn" class="gemini-btn bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md">Ask</button>
                </div>
                <div id="qa-output" class="mt-4 bg-slate-50 p-4 rounded-lg border hidden"></div>
            </div>
        `;

        modalContent.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl md:text-3xl font-bold text-slate-900">${data.title}</h2>
                <button onclick="hideModal()" class="text-slate-400 hover:text-slate-600 p-2 rounded-full transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div>
                ${mainContentHtml}
            </div>
            <div class="mt-6 border-t border-slate-200">
                <button class="accordion-btn">
                    <span>Explore with AI Tools</span>
                    <svg class="accordion-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div class="accordion-content">
                    <div class="py-4">
                        ${qaHtml}
                        <div class="border-t my-6 border-slate-200"></div>
                        ${aiToolsHtml}
                    </div>
                </div>
            </div>
        `;

        modalContainer.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        setTimeout(() => {
            modalContainer.style.opacity = '1';
            modalContent.style.transform = 'scale(1)';
        }, 10);

        // Accordion logic
        const accBtn = modalContent.querySelector(".accordion-btn");
        if (accBtn) {
            accBtn.addEventListener("click", function() {
                this.classList.toggle("active");
                const panel = this.nextElementSibling;
                if (panel.style.maxHeight) {
                    panel.style.maxHeight = null;
                } else {
                    panel.style.maxHeight = panel.scrollHeight + "px";
                }
            });
        }

        // Event listeners for AI Tools
        const explainBtn = document.getElementById('explain-btn');
        const meditateBtn = document.getElementById('meditate-btn');
        const geminiOutput = document.getElementById('gemini-output');
        if (explainBtn) {
            explainBtn.addEventListener('click', () => {
                const prompt = `You are an AI assistant knowledgeable in Tibetan Buddhism. Please explain the following concept in a simple and accessible way for someone new to the topic. Focus on the core meaning and its practical relevance. Here is the concept: ${data.rawContent}`;
                callGemini(prompt, geminiOutput);
            });
        }
        if (meditateBtn) {
            meditateBtn.addEventListener('click', () => {
                const prompt = `You are an AI assistant skilled in creating guided meditations. Based on the following Buddhist concept, please generate a short (approx. 150-200 words) guided meditation script. The script should be suitable for a beginner, with clear and simple instructions, starting with a settling-in phrase and ending with a gentle return to awareness. Here is the concept: ${data.rawContent}`;
                callGemini(prompt, geminiOutput);
            });
        }

        // Event listeners for Q&A tab
        const qaInput = document.getElementById('qa-input');
        const qaBtn = document.getElementById('qa-btn');
        const qaOutput = document.getElementById('qa-output');
        if (qaBtn) {
            qaBtn.addEventListener('click', () => {
                const question = qaInput.value;
                if (question.trim() === '') return;
                const prompt = `You are an AI assistant knowledgeable in Tibetan Buddhism. A user is asking a question about a specific topic. Please provide a clear and helpful answer based *only* on the provided context. If the user's question is unrelated to the context, politely state that you can only answer questions about the given topic. Context of the topic: "${data.rawContent}". User's question: "${question}"`;
                callGemini(prompt, qaOutput);
            });
            qaInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    qaBtn.click();
                }
            });
        }
    }

    function hideModal() {
        modalContainer.style.opacity = '0';
        modalContent.style.transform = 'scale(0.95)';
        setTimeout(() => {
            modalContainer.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }, 300);
    }

    // --- PDF DOWNLOAD LOGIC ---
    function downloadAsPdf() {
        const printContainer = document.createElement('div');
        printContainer.style.width = '8.5in';
        printContainer.style.padding = '0.5in';
        printContainer.style.boxSizing = 'border-box';
        printContainer.style.fontFamily = "'Inter', sans-serif";

        // Add Header
        const headerContent = document.querySelector('header .text-center').cloneNode(true);
        printContainer.appendChild(headerContent);

        // Add Infographic Image (as a static representation)
        const mainContent = document.querySelector('main .bg-white').cloneNode(true);
        // Remove interactive elements from the SVG for cleaner print
        mainContent.querySelectorAll('.node').forEach(node => {
            node.removeAttribute('onclick');
            node.style.cursor = 'default';
        });
        printContainer.appendChild(mainContent);

        const modalContentSection = document.createElement('div');
        modalContentSection.innerHTML = '<h2 style="font-size: 24px; font-weight: bold; margin-top: 40px; text-align: center; page-break-before: always;">Detailed Explanations</h2>';

        for (const key in modalData) {
            const data = modalData[key];
            const section = document.createElement('div');
            section.style.pageBreakInside = 'avoid';
            section.style.marginTop = '20px';
            section.style.padding = '20px';
            section.style.border = '1px solid #e2e8f0';
            section.style.borderRadius = '8px';
            section.style.backgroundColor = '#f8fafc';

            let tabsHtml = '';
            data.tabs.forEach(tab => {
                tabsHtml += `
                    <h4 style="font-size: 18px; font-weight: 600; margin-top: 15px; margin-bottom: 5px; color: #334155; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px;">${tab.title}</h4>
                    <div style="color: #475569; font-size: 16px; line-height: 1.6;">${tab.content}</div>
                `;
            });

            section.innerHTML = `
                <h3 style="font-size: 20px; font-weight: bold; margin-bottom: 10px; color: #1e293b;">${data.title}</h3>
                ${tabsHtml}
            `;
            modalContentSection.appendChild(section);
        }
        printContainer.appendChild(modalContentSection);

        printContainer.style.position = 'absolute';
        printContainer.style.left = '-9999px';
        document.body.appendChild(printContainer);

        const opt = {
          margin:       0,
          filename:     'Vajrayana_Journey_Infographic.pdf',
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2, useCORS: true, letterRendering: true },
          jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        html2pdf().from(printContainer).set(opt).save().then(() => {
            document.body.removeChild(printContainer);
        }).catch(err => {
            console.error("PDF generation failed:", err);
            document.body.removeChild(printContainer);
        });
    }

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('download-pdf-btn');
        if (btn) btn.addEventListener('click', downloadAsPdf);
    });

    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modalContainer.classList.contains('hidden')) {
            hideModal();
        }
    });

</script>

</body>
</html>
